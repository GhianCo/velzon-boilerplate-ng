<div class="container-fluid">
  <app-breadcrumbs [title]="'Visualizar Categorías con Control'" [breadcrumbItems]="breadCrumbItems"></app-breadcrumbs>

  @if (isLoading) {
    <div class="row">
      <div class="col-12">
        <div class="card">
          <div class="card-body text-center py-5">
            <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
              <span class="visually-hidden">Cargando...</span>
            </div>
            <h5 class="text-muted">Cargando datos...</h5>
          </div>
        </div>
      </div>
    </div>
  } @else if (hasError) {
    <div class="row">
      <div class="col-12">
        <div class="card border-danger">
          <div class="card-body text-center py-5">
            <i class="ri-error-warning-line text-danger" style="font-size: 72px;"></i>
            <h4 class="text-danger mt-3">Error al cargar</h4>
            <p class="text-muted">No se pudieron cargar los datos. Por favor, intenta nuevamente.</p>
            <button class="btn btn-primary mt-3" (click)="loadCategoriasConControl(resumenId!)">
              <i class="ri-restart-line me-1"></i>
              Reintentar
            </button>
          </div>
        </div>
      </div>
    </div>
  } @else if (categoriasData) {
    <!-- Tabla de Categorías con Control -->
    <div class="row">
      <div class="col-12">
        <div class="card">
          <div class="card-header bg-light">
            <h5 class="card-title mb-0">
              <i class="ri-table-line me-2"></i>Categorías con Control por Fecha
            </h5>
          </div>
          <div class="card-body p-0">
            <div class="table-responsive" style="overflow-x: auto; max-height: 70vh;">
              <table class="table table-bordered table-hover mb-0">
                <thead class="table-light sticky-top">
                  <!-- Fila 1: Headers principales -->
                  <tr>
                    <th rowspan="2" class="text-center align-middle" style="min-width: 250px; position: sticky; left: 0; background-color: #f8f9fa; z-index: 12;">
                      Descripción
                    </th>
                    @for (fecha of categoriasData.fechas; track fecha) {
                      <th colspan="3" class="text-center" style="min-width: 350px; background-color: #e9ecef;">
                        {{fecha}}
                      </th>
                    }
                    <th colspan="3" class="text-center" style="min-width: 350px; background-color: #d1ecf1;">
                      Total
                    </th>
                  </tr>

                  <!-- Fila 2: Subheaders -->
                  <tr>
                    @for (fecha of categoriasData.fechas; track fecha) {
                      <th class="text-center" style="min-width: 100px; background-color: #e3f2fd;">Registrado</th>
                      <th class="text-center" style="min-width: 120px; background-color: #fff3cd;">Control</th>
                      <th class="text-center" style="min-width: 100px; background-color: #f8d7da;">Diferencia</th>
                    }
                    <th class="text-center" style="min-width: 100px; background-color: #bee5eb;">Registrado</th>
                    <th class="text-center" style="min-width: 120px; background-color: #ffeeba;">Control</th>
                    <th class="text-center" style="min-width: 100px; background-color: #f5c6cb;">Diferencia</th>
                  </tr>
                </thead>

                <tbody>
                  <!-- Iterar por categorías -->
                  @for (categoria of categoriasData.categorias; track categoria.categoria_id) {
                    <!-- Header de categoría -->
                    <tr [ngClass]="{
                      'table-success': categoria.tipo_operacion === '+',
                      'table-danger': categoria.tipo_operacion === '-',
                      'table-warning': categoria.tipo_operacion === 'diff'
                    }">
                      <td colspan="1000" class="fw-bold py-2" style="position: sticky; left: 0; z-index: 10;"
                          [ngClass]="{
                            'table-success': categoria.tipo_operacion === '+',
                            'table-danger': categoria.tipo_operacion === '-',
                            'table-warning': categoria.tipo_operacion === 'diff'
                          }">
                        @if (categoria.tipo_operacion === '+') {
                          <i class="ri-arrow-up-circle-fill me-2 text-success"></i>
                        } @else if (categoria.tipo_operacion === '-') {
                          <i class="ri-arrow-down-circle-fill me-2 text-danger"></i>
                        } @else {
                          <i class="ri-alert-line me-2 text-warning"></i>
                        }
                        {{ categoria.nombre }}
                      </td>
                    </tr>

                    <!-- Items de la categoría -->
                    @for (item of $any(categoria.items); track item.id) {
                      <tr>
                        <!-- Nombre del item -->
                        <td class="align-middle ps-4" style="position: sticky; left: 0; background-color: white; z-index: 10;">
                          <span class="fw-medium">{{ item.nombre }}</span>
                        </td>

                        <!-- Columnas por fecha -->
                        @for (fecha of categoriasData.fechas; track fecha) {
                          <!-- Registrado -->
                          <td class="text-center align-middle">
                            <span class="text-muted">{{ item.registrado[fecha] }}</span>
                          </td>

                          <!-- Control -->
                          <td class="text-center align-middle">
                            <span class="fw-medium">{{ item.control[fecha] }}</span>
                          </td>

                          <!-- Diferencia -->
                          <td class="text-center align-middle"
                              [ngClass]="{'bg-danger bg-opacity-10': (item.control[fecha] - item.registrado[fecha]) !== 0}">
                            <span class="fw-bold"
                                  [ngClass]="{
                                    'text-danger': (item.control[fecha] - item.registrado[fecha]) < 0,
                                    'text-success': (item.control[fecha] - item.registrado[fecha]) > 0
                                  }">
                              {{ (item.control[fecha] - item.registrado[fecha]).toFixed(2) }}
                            </span>
                          </td>
                        }

                        <!-- Columna Total -->
                        <td class="text-center align-middle" style="background-color: #bee5eb;">
                          <span class="fw-medium">
                            {{ getSumaTotalRegistradoItem(item).toFixed(2) }}
                          </span>
                        </td>
                        <td class="text-center align-middle" style="background-color: #ffeeba;">
                          <span class="fw-medium">
                            {{ getSumaTotalControlItem(item).toFixed(2) }}
                          </span>
                        </td>
                        <td class="text-center align-middle" style="background-color: #f5c6cb;">
                          <span class="fw-bold"
                                [ngClass]="{
                                  'text-danger': getSumaTotalDiferenciaItem(item) < 0,
                                  'text-success': getSumaTotalDiferenciaItem(item) > 0
                                }">
                            {{ getSumaTotalDiferenciaItem(item).toFixed(2) }}
                          </span>
                        </td>
                      </tr>
                    }

                    <!-- Subtotal de categoría -->
                    <tr class="fw-bold" style="background-color: #f8f9fa;">
                      <td class="ps-4" style="position: sticky; left: 0; background-color: #f8f9fa; z-index: 10;">
                        Subtotal {{ categoria.nombre }}
                      </td>
                      @for (fecha of categoriasData.fechas; track fecha) {
                        <td class="text-center" style="background-color: #e3f2fd;">
                          {{ getSubtotal(categoria.items, fecha, 'registrado').toFixed(2) }}
                        </td>
                        <td class="text-center" style="background-color: #fff3cd;">
                          {{ getSubtotal(categoria.items, fecha, 'control').toFixed(2) }}
                        </td>
                        <td class="text-center" style="background-color: #f8d7da;">
                          {{ getDiferenciaTotal(categoria.items, fecha).toFixed(2) }}
                        </td>
                      }
                      <!-- Subtotal total de la categoría -->
                      <td class="text-center" style="background-color: #bee5eb;">
                        {{ getSumaTotalColumna(categoria.items, 'registrado').toFixed(2) }}
                      </td>
                      <td class="text-center" style="background-color: #ffeeba;">
                        {{ getSumaTotalColumna(categoria.items, 'control').toFixed(2) }}
                      </td>
                      <td class="text-center" style="background-color: #f5c6cb;">
                        {{ getSumaTotalDiferenciaItems(categoria.items).toFixed(2) }}
                      </td>
                    </tr>
                  }

                  <!-- Fila de TOTAL GENERAL -->
                  <tr class="fw-bold" style="background-color: #e9ecef; font-size: 1.05rem;">
                    <td style="position: sticky; left: 0; background-color: #e9ecef; z-index: 10;">
                      TOTAL GENERAL
                    </td>
                    @for (fecha of categoriasData.fechas; track fecha) {
                      <td class="text-center" style="background-color: #bbdefb;">
                        {{ getTotalGeneral('registrado')[fecha]?.toFixed(2) || '0.00' }}
                      </td>
                      <td class="text-center" style="background-color: #ffe082;">
                        {{ getTotalGeneral('control')[fecha]?.toFixed(2) || '0.00' }}
                      </td>
                      <td class="text-center" style="background-color: #ef9a9a;">
                        {{ getTotalGeneralDiferencia()[fecha]?.toFixed(2) || '0.00' }}
                      </td>
                    }
                    <!-- Total general de todas las fechas -->
                    <td class="text-center" style="background-color: #81d4fa;">
                      {{ getSumaTotalGeneralPorTipo('registrado').toFixed(2) }}
                    </td>
                    <td class="text-center" style="background-color: #ffd54f;">
                      {{ getSumaTotalGeneralPorTipo('control').toFixed(2) }}
                    </td>
                    <td class="text-center" style="background-color: #e57373;">
                      {{ getSumaTotalGeneralDiferencia().toFixed(2) }}
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  } @else {
    <div class="row">
      <div class="col-12">
        <div class="card">
          <div class="card-body text-center py-5">
            <div class="mb-4">
              <i class="ri-file-search-line display-1 text-muted"></i>
            </div>
            <h5 class="text-muted mb-3">No hay datos para mostrar</h5>
            <p class="text-muted mb-0">
              No se encontraron datos para el resumen seleccionado
            </p>
          </div>
        </div>
      </div>
    </div>
  }

