<div class="container-fluid">
    <app-breadcrumbs [title]="'Resumen cuadre de suma diaria'" [breadcrumbItems]="breadCrumbItems"></app-breadcrumbs>

    @if (isLoading) {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <p class="mt-3">Cargando resumen...</p>
        </div>
    } @else if (hasError) {
        <div class="card border-danger">
            <div class="card-body text-center py-5">
                <i class="ri-error-warning-line text-danger" style="font-size: 72px;"></i>
                <h4 class="text-danger mt-3">Error al cargar</h4>
                <button class="btn btn-primary mt-3" (click)="loadResumen(operacionTurnoId!)">
                    Reintentar
                </button>
            </div>
        </div>
    } @else if (resumenData) {
        <!-- Resumen del Turno -->
        <div class="row mb-4">
            <!-- Card: Información del Turno (3 columnas visuales) -->
            <div class="col-md-5">
                <div class="card h-100">
                    <div class="card-body">
                        <h6 class="text-muted mb-3 fs-13">
                            <i class="ri-time-line me-1"></i>Información del Turno
                        </h6>
                        <div class="row g-3">
                            <div class="col-4">
                                <div class="p-3 border border-dashed rounded">
                                    <p class="text-muted mb-2 fs-12">
                                        {{ resumenData.turno_nombre }}
                                    </p>
                                    <h6 class="mb-0">{{ resumenData.sala }}</h6>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="p-3 border border-dashed rounded">
                                    <p class="text-muted mb-2 fs-12">
                                        <i class="ri-login-circle-line me-1"></i>Apertura
                                    </p>
                                    <h6 class="mb-0">{{ resumenData.apertura }}</h6>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="p-3 border border-dashed rounded">
                                    <p class="text-muted mb-2 fs-12">
                                        <i class="ri-logout-circle-line me-1"></i>Cierre
                                    </p>
                                    <h6 class="mb-0">{{ resumenData.cierre }}</h6>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Card: Resumen Financiero (4 columnas visuales) -->
            <div class="col-md-7">
                <div class="card h-100">
                    <div class="card-body">
                        <h6 class="text-muted mb-3 fs-13">
                            <i class="ri-money-dollar-circle-line me-1"></i>Resumen Financiero
                        </h6>
                        <div class="row g-3">
                            <div class="col-3">
                                <div class="p-3 border border-dashed rounded text-center">
                                    <p class="text-muted mb-2 fs-12">Total Apertura</p>
                                    <h5 class="mb-0">{{ resumenData.simbolo_moneda }} {{ resumenData.inventario_apertura.total }}</h5>
                                </div>
                            </div>
                            <div class="col-3">
                                <div class="p-3 border border-dashed rounded text-center">
                                    <p class="text-muted mb-2 fs-12">Total Cierre</p>
                                    <h5 class="mb-0">{{ resumenData.simbolo_moneda }} {{ resumenData.inventario_cierre.total }}</h5>
                                </div>
                            </div>
                            <div class="col-3">
                                <div class="p-3 border border-dashed border-success rounded text-center">
                                    <p class="text-success mb-2 fs-12">
                                        <i class="ri-arrow-up-circle-fill me-1"></i>Ingresos
                                    </p>
                                    <h5 class="mb-0 text-success">{{ resumenData.simbolo_moneda }} {{ resumenData.suma_diaria.subtotales.ingresos }}</h5>
                                </div>
                            </div>
                            <div class="col-3">
                                <div class="p-3 border border-dashed border-danger rounded text-center">
                                    <p class="text-danger mb-2 fs-12">
                                        <i class="ri-arrow-down-circle-fill me-1"></i>Egresos
                                    </p>
                                    <h5 class="mb-0 text-danger">{{ resumenData.simbolo_moneda }} {{ resumenData.suma_diaria.subtotales.egresos }}</h5>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- TABLAS CON SCROLL INDEPENDIENTE -->
        <div class="row g-3">
            <!-- TABLA 1: INVENTARIO DE EFECTIVO -->
            <div class="col-12 col-xl-8">
                <div class="card">
                    <div class="card-header bg-light">
                        <h5 class="card-title mb-0">
                            <i class="ri-inbox-line me-2"></i>Inventario de Efectivo
                        </h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive" style="overflow-x: auto; max-height: 70vh;">
                            <table class="table table-bordered mb-0 w-100">
                                <thead>
                                <!-- Fila 1: Inventario Apertura e Inventario Cierre -->
                                <tr>
                                    <!-- Columna Descripción (sticky) -->
                                    <th rowspan="2" class="text-center align-middle"
                                        style="min-width: 200px; position: sticky; left: 0; background-color: #f8f9fa; z-index: 12;">
                                        Descripción
                                    </th>

                                    <!-- Inventario de Apertura -->
                                    <th [attr.colspan]="resumenData.inventario_apertura.cajas.length + 1"
                                        class="text-center" style="background-color: #e3f2fd;">
                                        Apertura
                                    </th>

                                    <!-- Inventario de Cierre -->
                                    <th [attr.colspan]="resumenData.inventario_cierre.cajas.length + 1"
                                        class="text-center" style="background-color: #fce4ec;">
                                        Cierre
                                    </th>
                                </tr>

                                <!-- Fila 2: Cajas individuales -->
                                <tr>
                                    <!-- Cajas Apertura -->
                                    @for (caja of resumenData.inventario_apertura.cajas; track caja.caja_id) {
                                        <th class="text-center" style="min-width: 100px; font-size: 0.85rem; background-color: #e3f2fd;">
                                            {{ caja.caja_nombre }}
                                        </th>
                                    }
                                    <th class="text-center" style="min-width: 100px; background-color: #bbdefb; font-weight: bold;">
                                        Total
                                    </th>

                                    <!-- Cajas Cierre -->
                                    @for (caja of resumenData.inventario_cierre.cajas; track caja.caja_id) {
                                        <th class="text-center" style="min-width: 100px; font-size: 0.85rem; background-color: #fce4ec;">
                                            {{ caja.caja_nombre }}
                                        </th>
                                    }
                                    <th class="text-center" style="min-width: 100px; background-color: #f8bbd0; font-weight: bold;">
                                        Total
                                    </th>
                                </tr>
                                </thead>
                                <tbody>
                                <!-- Iterar por valores (Fichas, Soles, Dólares) -->
                                @for (valor of resumenData.inventario_apertura.valores; track valor.valor_id; let vIdx = $index) {
                                    <!-- Header de grupo -->
                                    <tr style="background-color: #f8f9fa;">
                                        <td class="fw-bold" style="position: sticky; left: 0; background-color: #f8f9fa; z-index: 10;">
                                            <i class="ri-checkbox-blank-circle-fill me-2" style="font-size: 8px;"></i>
                                            {{ valor.nombre }}
                                        </td>
                                        <td [attr.colspan]="resumenData.inventario_apertura.cajas.length + resumenData.inventario_cierre.cajas.length + 2"></td>
                                    </tr>

                                    <!-- Fila de Tipo de Cambio (solo para USD) -->
                                    @if (valor.codigo === 'USD') {
                                        <tr style="background-color: #fff3cd;">
                                            <td class="fw-medium fst-italic" style="position: sticky; left: 0; background-color: #fff3cd; z-index: 10;">
                                                <i class="ri-exchange-line me-2"></i>Tipo de cambio
                                            </td>
                                            <td class="text-center align-middle fw-bold" [attr.colspan]="(resumenData.inventario_apertura.cajas.length + resumenData.inventario_cierre.cajas.length) + 2">
                                                S/. {{ valor.tc || '0.00' }}
                                            </td>
                                        </tr>
                                    }

                                    <!-- Filas de denominaciones -->
                                    @for (denominacion of valor.denominaciones; track denominacion.denominacion_id; let dIdx = $index) {
                                        <tr>
                                            <!-- Denominación (sticky) -->
                                            <td style="position: sticky; left: 0; background-color: white; z-index: 10;">
                                                {{ denominacion.descripcion }}
                                            </td>

                                            <!-- Cantidades Apertura -->
                                            @for (cajaData of denominacion.cajas; track cajaData.caja_id) {
                                                <td class="text-center align-middle">
                                                    <span class="fw-medium">{{ cajaData.cantidad }}</span>
                                                </td>
                                            }
                                            <!-- Total Apertura -->
                                            <td class="text-center align-middle" style="background-color: #e3f2fd;">
                                                <strong>{{ resumenData.simbolo_moneda }} {{ denominacion.total_importe }}</strong>
                                            </td>

                                            <!-- Cantidades Cierre -->
                                            @if (resumenData.inventario_cierre.valores[vIdx]?.denominaciones[dIdx]) {
                                                @for (cajaData of resumenData.inventario_cierre.valores[vIdx].denominaciones[dIdx].cajas; track cajaData.caja_id) {
                                                    <td class="text-center align-middle">
                                                        <span class="fw-medium">{{ cajaData.cantidad }}</span>
                                                    </td>
                                                }
                                                <!-- Total Cierre -->
                                                <td class="text-center align-middle" style="background-color: #fce4ec;">
                                                    <strong>{{ resumenData.simbolo_moneda }} {{ resumenData.inventario_cierre.valores[vIdx].denominaciones[dIdx].total_importe }}</strong>
                                                </td>
                                            } @else {
                                                @for (caja of resumenData.inventario_cierre.cajas; track caja.caja_id) {
                                                    <td class="text-center"><span class="text-muted">−</span></td>
                                                }
                                                <td class="text-center" style="background-color: #fce4ec;">
                                                    <span class="text-muted">−</span>
                                                </td>
                                            }
                                        </tr>
                                    }
                                }

                                <!-- Fila de TOTALES -->
                                <tr style="background-color: #e9ecef; font-weight: bold;">
                                    <td style="position: sticky; left: 0; background-color: #e9ecef; z-index: 10;">
                                        TOTAL
                                    </td>
                                    <td [attr.colspan]="resumenData.inventario_apertura.cajas.length" class="text-end"></td>
                                    <td class="text-center" style="background-color: #bbdefb;">
                                        {{ resumenData.simbolo_moneda }} {{ resumenData.inventario_apertura.total }}
                                    </td>
                                    <td [attr.colspan]="resumenData.inventario_cierre.cajas.length" class="text-end"></td>
                                    <td class="text-center" style="background-color: #f8bbd0;">
                                        {{ resumenData.simbolo_moneda }} {{ resumenData.inventario_cierre.total }}
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TABLA 2: SUMA DIARIA DE EFECTIVO -->
            <div class="col-12 col-xl-4">
                <div class="card">
                    <div class="card-header bg-light">
                        <h5 class="card-title mb-0">
                            <i class="ri-calculator-line me-2"></i>Suma Diaria de Efectivo
                        </h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive" style="overflow-y: auto; max-height: 70vh;">
                            <table class="table table-bordered table-hover mb-0">
                                <thead class="sticky-top" style="z-index: 10;">
                                    <tr>
                                        <th style="min-width: 200px;">Descripción</th>
                                        <th class="text-end" style="min-width: 120px;">Importe</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Iterar por categorías -->
                                    @for (categoria of resumenData.suma_diaria.categorias; track categoria.categoria_id) {
                                        <!-- Header de categoría -->
                                        <tr [ngClass]="{
                                            'table-success': categoria.tipo_operacion === 'ingreso',
                                            'table-danger': categoria.tipo_operacion === 'egreso',
                                            'table-warning': categoria.tipo_operacion === 'diferencia'
                                        }">
                                            <td class="fw-bold" colspan="2">
                                                @if (categoria.tipo_operacion === 'ingreso') {
                                                    <i class="ri-arrow-up-circle-fill me-2"></i>
                                                } @else if (categoria.tipo_operacion === 'egreso') {
                                                    <i class="ri-arrow-down-circle-fill me-2"></i>
                                                } @else {
                                                    <i class="ri-alert-line me-2"></i>
                                                }
                                                {{ categoria.nombre }}
                                            </td>
                                        </tr>

                                        <!-- Items de la categoría -->
                                        @if (categoria.items && isArray(categoria.items)) {
                                            @for (item of $any(categoria.items); track item.id) {
                                                <tr>
                                                    <td class="ps-4">
                                                        <span style="font-size: 0.9rem;">{{ item.nombre }}</span>
                                                    </td>
                                                    <td class="text-end">
                                                        <span class="fw-medium"
                                                              [ngClass]="{
                                                                  'text-success': categoria.tipo_operacion === 'ingreso',
                                                                  'text-danger': categoria.tipo_operacion === 'egreso',
                                                                  'text-warning': categoria.tipo_operacion === 'diferencia'
                                                              }">
                                                            {{ resumenData.simbolo_moneda }} {{ item.importe }}
                                                        </span>
                                                    </td>
                                                </tr>
                                            }
                                        }
                                    }

                                    <!-- Fila de TOTAL -->
                                    <tr style="background-color: #e9ecef; font-weight: bold;">
                                        <td>TOTAL</td>
                                        <td class="text-end">
                                            {{ resumenData.simbolo_moneda }} {{ resumenData.suma_diaria.total }}
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

